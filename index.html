package stepDefinitions;

import io.cucumber.java.en.Given;
import io.cucumber.java.en.Then;
import io.cucumber.java.en.When;
import io.restassured.RestAssured;
import io.restassured.response.Response;

import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.equalTo;

public class SmokeStepDefinitions {

    private static final String ACC_ID = "1688745";
    private static final String ACC_REF_ID = "jg5mFCxvS9%2BsoKzXLPONREX2BzFK0mWFGNu16UZjjybk6EX30";
    private static final String ENV = "https://localhost:8443/private/";
    private static final String SBB_PATH = "/small-business/accounts/";
    private static final String URL_CONTD = "/transactions/download";

    private Response response;

    @Given("the function was deployed")
    public void the_function_was_deployed() {
        System.out.println("Verifying that the function is deployed.");
    }

    @When("the function is invoked")
    public void the_function_is_invoked() {
        String payload = "{"
                + "\"accountNumberLastFour\": \"4284\","
                + "\"bankRoutingNumber\": \"865000090\","
                + "\"fileType\": \"CSV\","
                + "\"LedgerBalance\": \"422227\","
                + "\"startDate\": \"2024-08-02\","
                + "\"endDate\": \"2024-10-31\","
                + "\"accountCategory\": \"CHECKING\","
                + "\"accountType\": \"CHECKING\""
                + "}";

        response = RestAssured.given()
                .relaxedHTTPSValidation()
                .header("Accept", "application/json")
                .header("Content-Type", "application/json")
                .header("Client-Correlation-Id", "SbbTest123")
                .header("profileReferenceId", "rd56DeD6/Hn9J0BYuktgkLzXP3Lw5Yz1QlVnnTmJ39UhFdgg30EBJjHfBm0NrkW/NxLWO8ygmd011hSRrzgy43/RAmirdLHyy6@FOGV0/1s=")
                .body(payload)
                .when()
                .post(ENV + ACC_ID + SBB_PATH + ACC_REF_ID + URL_CONTD);

        System.out.println("Function invoked. URL: " + (ENV + ACC_ID + SBB_PATH + ACC_REF_ID + URL_CONTD) 
            + " Response status: " + response.getStatusCode());
    }

    @Then("the function returns a successful response")
    public void the_function_returns_a_successful_response() {
        assertThat("Response status is not 200", response.getStatusCode(), equalTo(200));
        System.out.println("Function executed successfully. Response: " + response.getBody().asString());
    }
}
